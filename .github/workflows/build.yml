name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - uses: mamba-org/setup-micromamba@v2
      with:
        environment-file: environment.yml
        environment-name: ci

    - name: Activate environment
      run: echo "$MAMBA_ROOT_PREFIX/envs/ci/bin" >> $GITHUB_PATH

    - name: Install
      run: python3 -m pip install -q .

    - name: Test
      run: |
        python3 -m coverage run -m pytest
        python3 -m coverage xml

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v3
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Lint
      run: ruff check psico tests

    - name: Type checking
      run: mypy

  build-min:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - uses: mamba-org/setup-micromamba@v2
      with:
        environment-file: environment-min.yml
        environment-name: min
        generate-run-shell: true

    - name: Test
      run: python3 -m pytest -v
      shell: micromamba-shell {0}

  build-max:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - uses: mamba-org/setup-micromamba@v2
      with:
        environment-file: environment-max.yml
        environment-name: max
        generate-run-shell: true

    - name: Test
      run: python3 -m pytest -v -k "not dssp"
      shell: micromamba-shell {0}
